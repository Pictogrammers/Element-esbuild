#!/usr/bin/env node
import { createRequire } from 'node:module'; const require = createRequire(import.meta.url);
import{fileURLToPath as pe,pathToFileURL as le}from"node:url";import{build as me}from"esbuild";import{sep as B}from"node:path";import{readFile as ee}from"node:fs/promises";function z(e){return e.replace(/-([a-z])/g,a=>a[1].toUpperCase())}var te=process.cwd(),ne=te.split(B).length,U={name:"html-dependents-plugin",setup(e){e.onLoad({filter:/\.html$/},async a=>{let m=a.path.split(B).splice(ne),[g,M,w,b,...h]=m,i=await ee(a.path,"utf8"),v=i.matchAll(/<\/(?<namespace>\w+)-(?<value>[^>]+)/g),$=new Map;for(let t of v){let{namespace:c,value:l}=t.groups,x=z(l);$.set(`${c}-${x}`,[c,x])}let n=[];return $.forEach(([t,c])=>{let l=m.length-4,x=new Array(l).fill("..");if(t===w){if(c===b)return;n.push(`import './${x.join("/")}/${c}/${c}';`)}else n.push(`import './${x.join("/")}/${t}/${c}/${c}';`)}),n.push(`export default \`${i}\`;`),{contents:n.join(`
`),loader:"js"}})}};var oe=e=>`\x1B[32m${e}\x1B[0m`,Z={name:"rebuild-notify",setup(e){e.onEnd(a=>{a.errors.length>0?console.error(`Build ended with ${a.errors.length} errors`):console.log(oe("Build succeeded!"))})}};import{access as re}from"node:fs/promises";import{constants as se}from"node:fs";async function y(e){try{return await re(e,se.F_OK),!0}catch{return!1}}import{copyFile as X,writeFile as ue}from"node:fs/promises";import{dirname as fe,join as D}from"node:path";import{join as d}from"node:path";import{readdir as ae}from"node:fs/promises";async function F(e){let a=[];try{let m=await ae(e,{withFileTypes:!0});for(let g of m)g.isDirectory()&&a.push(g.name)}catch(m){console.error("Error reading directory:",m)}return a}import{access as ie}from"node:fs/promises";import{constants as ce}from"node:fs";async function H(e){try{return await ie(e,ce.F_OK),!0}catch{return!1}}import{readFile as S}from"node:fs/promises";function I(e){return e&&e.charAt(0).toUpperCase()+e.slice(1)}function N(e){return e.replace(/([a-zA-Z])(?=[A-Z])/g,"$1-").toLowerCase()}var L=e=>`\x1B[31m${e}\x1B[0m`,We=process.cwd();var _="src",C="components";function k(e){return{name:"playground-plugin",setup(a){let m="playground-entry",g="playground-module";a.onResolve({filter:new RegExp(`^${m}$`)},M=>({path:m,namespace:g})),a.onLoad({filter:/.*/,namespace:g},async M=>{let w=[],b=await F(d(_,C));b.length===0&&(console.log(L('Missing at least 1 namespace folder under "src/components/"')),process.exit());let h=[];for(let i of b){let v={namespace:i,components:[]};h.push(v);let $=d(_,C,i),n=await F($);for(let t of n)if(await y(d(_,C,i,t,`${t}.ts`))){let c="";await y(d(_,C,i,t,"README.md"))&&(c=await S(d(_,C,i,t,"README.md"),"utf8"));let l={namespace:i,component:t,tag:`${i}-${N(t)}`,examples:[],className:"",classExtends:"",readme:c};if(w.push(`import '${C}/${i}/${t}/${t}';`),await H(d($,t,"__examples__"))){let s=await F(d($,t,"__examples__"));for(let o of s)await y(d($,t,"__examples__",o,`${o}.ts`))?(w.push(`import '${C}/${i}/${t}/__examples__/${o}/${o}';`),l.examples.push({namespace:i,component:t,example:o,tag:`x-${i}-${N(t)}-${N(o)}`,className:`X${I(i)}${I(t)}${I(o)}`})):console.log(L(`Missing ${C}/${i}/${t}/__examples__/${o}/${o}.ts`))}let p=(await S(d(_,C,i,t,`${t}.ts`),"utf8")).match(/class (\w+) extends (\w+)/);p||(console.log(L(`Component "${i}-${t}" must extend HtmlElement or base class`)),process.exit()),l.className=p[1],l.classExtends=p[2],v.components.push(l)}}return e.after(h),{contents:w.join(`
`),resolveDir:d(process.cwd(),_)}})}}}import{join as O}from"node:path";import{readFile as J}from"node:fs/promises";async function K({mode:e,rootDir:a,srcDir:m,indexFile:g,defaultDir:M,playgroundFile:w,title:b,repo:h,repoComponent:i,navigation:v,namespaces:$}){let n="";await y(O(a,m,g))?n=await J(O(a,m,g),"utf8"):n=await J(O(M,w),"utf8"),n=n.replace("<title>Default</title>",`<title>${b??"Default"}</title>`),n=n.replace("<h1>Default</h1>",`<h1>${b??"Default"}</h1>`);let t=structuredClone(v??[]);for(let p of t)p.items=[];let c;t.length===0?(c={label:"Components",items:[]},t.push(c)):(c=t.find(p=>!p.extends&&!p.components&&!p.namespaces),c||(c={label:"Other",items:[]},t.push(c)));let l=new Map;if($.forEach(({components:p})=>{p.forEach(({component:s,namespace:o,tag:u,readme:A,examples:j,className:f,classExtends:P})=>{l.set(f,{className:f,classExtends:P,component:s,namespace:o,tag:u,readme:A,examples:j.map(r=>r.className)}),j.forEach(r=>{l.set(r.className,{className:r.className,classExtends:r.classExtends,component:r.component,namespace:r.namespace,tag:r.tag,example:r.example})});for(let r of t)if(r.include&&r.include.includes(f)){r.items.push({namespace:o,component:s,className:f,tag:u});return}for(let r of t)if(r!==c&&!(r.exclude&&r.exclude.includes(f))&&!(r.namespaces&&!r.namespaces.includes(o))&&!(r.extends&&!r.extends.includes(P))){r.items.push({namespace:o,component:s,className:f,tag:u});return}c.items.push({namespace:o,component:s,examples:j,className:f,tag:u})})}),n=n.replace(/([ ]*)<!-- \[Navigation\] -->/,(p,s)=>t.map(({label:o,items:u})=>[s,`<div>${o}</div>`,"<ul>",u.map(({component:A,namespace:j,tag:f,className:P})=>[`<li data-tag="${f}" data-class-name="${P}" data-component="${A}"><a href="#${f}">${A}</a></li>`].join(`
${s}`)).join(`
${s}`),"</ul>"].join(`
${s}`)).join(`
${s}`)),h){let o=h.includes("github.com")?"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z":"M6,2H18A2,2 0 0,1 20,4V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2M12.75,13.5C15.5,13.5 16.24,11.47 16.43,10.4C17.34,10.11 18,9.26 18,8.25C18,7 17,6 15.75,6C14.5,6 13.5,7 13.5,8.25C13.5,9.19 14.07,10 14.89,10.33C14.67,11 14,12 12,12C10.62,12 9.66,12.35 9,12.84V8.87C9.87,8.56 10.5,7.73 10.5,6.75C10.5,5.5 9.5,4.5 8.25,4.5C7,4.5 6,5.5 6,6.75C6,7.73 6.63,8.56 7.5,8.87V15.13C6.63,15.44 6,16.27 6,17.25C6,18.5 7,19.5 8.25,19.5C9.5,19.5 10.5,18.5 10.5,17.25C10.5,16.32 9.94,15.5 9.13,15.18C9.41,14.5 10.23,13.5 12.75,13.5M8.25,16.5A0.75,0.75 0 0,1 9,17.25A0.75,0.75 0 0,1 8.25,18A0.75,0.75 0 0,1 7.5,17.25A0.75,0.75 0 0,1 8.25,16.5M8.25,6A0.75,0.75 0 0,1 9,6.75A0.75,0.75 0 0,1 8.25,7.5A0.75,0.75 0 0,1 7.5,6.75A0.75,0.75 0 0,1 8.25,6M15.75,7.5A0.75,0.75 0 0,1 16.5,8.25A0.75,0.75 0 0,1 15.75,9A0.75,0.75 0 0,1 15,8.25A0.75,0.75 0 0,1 15.75,7.5Z";n=n.replace(/([ ]*)<!-- \[Repo\] -->/,(u,A)=>[A,`<a href="${h}">`,'  <svg viewBox="0 0 24 24">',`    <path fill="currentColor" d="${o}" />`,"  </svg>","  <span>View Repo</span>","</a>"].join(`
${A}`)),n=n.replace(/const repo = '';/,u=>`const repo = '${h}';`),n=n.replace(/const repoComponent = '';/,u=>`const repoComponent = '${i.replace(/\$repo/g,h)}';`),n=n.replace(/const repoIcon = '';/,u=>`const repoIcon = '${o}';`)}e==="dev"&&(n=n.replace(/([ ]*)<!-- \[info\] -->/,(p,s)=>[s,"<p>This page is generated from <code>npm start</code>. To render only specific components use <code>npm start c-button</code>.</p>"].join(`
${s}`)));let x=[...l.keys()];return n=n.replace(/([ ]*)const componentMap = new Map\(\);/,(p,s)=>[`${s}const componentMap = new Map();`,...x.map(o=>{let u=l.get(o);return`componentMap.set('${o}', ${JSON.stringify(u)});`})].join(`${s}
`)),n=n.replace(/([ ]*)const navigation = \[\];/,(p,s)=>`${s}const navigation = ${JSON.stringify(t,null,"  ")};`),n}var Q=[U,Z],V=[],de=e=>`\x1B[32m${e}\x1B[0m`,ge=e=>`\x1B[31m${e}\x1B[0m`,he="playground.html",$e=pe(import.meta.url),ye=fe($e),W=D(ye,"..","default"),q="index.html";var R="src",Ce="components",Y="element.config.ts",E=process.cwd(),T="build",xe=le(Y);await y(Y)||(console.log(ge("Missing element.config.ts in root."),"Add with content:"),console.log("export default {"),console.log("  namespace: 'hello',"),console.log("}"),process.exit());var we=await import(xe.href),{namespace:G,title:be,repo:Ae,repoComponent:_e,navigation:De}=we.default;G?(console.log(de("Building app...")),V.push(`./${R}/${Ce}/${G}/app/app.ts`)):(V.push("playground-entry"),Q.push(k({after:async e=>{let a=await K({mode:"production",rootDir:E,srcDir:R,indexFile:q,defaultDir:W,playgroundFile:he,title:be,repo:Ae,repoComponent:_e,navigation:De,namespaces:e});await ue(D(E,T,q),a)}})));me({entryPoints:V,bundle:!0,platform:"browser",outfile:`./${T}/main.js`,sourcemap:!1,minify:!0,format:"esm",target:"es2024",loader:{".html":"text",".css":"text"},plugins:Q}).then(async()=>{let e="favicon.svg";await y(D(E,R,e))?await X(D(E,R,e),D(E,T,e)):await X(D(W,e),D(E,T,e))}).catch(e=>{process.stderr.write(e.stderr),process.exit(1)});

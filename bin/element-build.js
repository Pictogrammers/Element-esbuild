#!/usr/bin/env node
import { createRequire } from 'node:module'; const require = createRequire(import.meta.url);
import{fileURLToPath as de,pathToFileURL as ge}from"node:url";import{build as he}from"esbuild";import{sep as z}from"node:path";import{readFile as oe}from"node:fs/promises";function k(e){return e.replace(/-([a-z])/g,a=>a[1].toUpperCase())}var se="node_modules",re=process.cwd(),ae=re.split(z).length,ie=e=>`\x1B[31m${e}\x1B[0m`;function B({localNamespaces:e,externalNamespaces:a}){return{name:"html-dependents-plugin",setup(m){m.onLoad({filter:/\.html$/},async d=>{let v=d.path.split(z).splice(ae),[M,E,g,c,...P]=v,y=await oe(d.path,"utf8"),o=y.matchAll(/<\/(?<namespace>\w+)-(?<value>[^>]+)/g),t=new Map;for(let l of o){let{namespace:u,value:i}=l.groups,n=k(i);t.set(`${u}-${n}`,[u,n])}let p=[];return t.forEach(([l,u])=>{let i=v.length-4,n=new Array(i).fill("..");if(l===g){if(u===c)return;p.push(`import './${n.join("/")}/${u}/${u}';`)}else if(e.includes(l))p.push(`import './${n.join("/")}/${l}/${u}/${u}';`);else if(a.has(l)){n.push(".."),n.push(".."),n.push("..");let s=a.get(l);p.push(`import './${n.join("/")}/${se}/${s}/${l}/${u}/${u}';`)}else console.log(ie(`Unable to find namespace folder "${l}". Possibly missing 'external' in element.config.ts`)),process.exit()}),p.push(`export default \`${y}\`;`),{contents:p.join(`
`),loader:"js"}})}}}var ce=e=>`\x1B[32m${e}\x1B[0m`,Z={name:"rebuild-notify",setup(e){e.onEnd(a=>{a.errors.length>0?console.error(`Build ended with ${a.errors.length} errors`):console.log(ce("Build succeeded!"))})}};import{access as le}from"node:fs/promises";import{constants as pe}from"node:fs";async function x(e){try{return await le(e,pe.F_OK),!0}catch{return!1}}import{copyFile as q,writeFile as $e}from"node:fs/promises";import{dirname as ye,join as w}from"node:path";import{join as $}from"node:path";import{readdir as me}from"node:fs/promises";async function _(e){let a=[];try{let m=await me(e,{withFileTypes:!0});for(let d of m)d.isDirectory()&&a.push(d.name)}catch(m){console.error("Error reading directory:",m)}return a}import{access as ue}from"node:fs/promises";import{constants as fe}from"node:fs";async function H(e){try{return await ue(e,fe.F_OK),!0}catch{return!1}}import{readFile as S}from"node:fs/promises";function I(e){return e&&e.charAt(0).toUpperCase()+e.slice(1)}function T(e){return e.replace(/([a-zA-Z])(?=[A-Z])/g,"$1-").toLowerCase()}var O=e=>`\x1B[31m${e}\x1B[0m`,st=process.cwd();var A="src",C="components";function J(e){return{name:"playground-plugin",setup(a){let m="playground-entry",d="playground-module";a.onResolve({filter:new RegExp(`^${m}$`)},v=>({path:m,namespace:d})),a.onLoad({filter:/.*/,namespace:d},async v=>{let M=[],E=await _($(A,C));E.length===0&&(console.log(O('Missing at least 1 namespace folder under "src/components/"')),process.exit());let g=[];for(let c of E){let P={namespace:c,components:[]};g.push(P);let y=$(A,C,c),o=await _(y);for(let t of o)if(await x($(A,C,c,t,`${t}.ts`))){let p="";await x($(A,C,c,t,"README.md"))&&(p=await S($(A,C,c,t,"README.md"),"utf8"));let l={namespace:c,component:t,tag:`${c}-${T(t)}`,examples:[],className:"",classExtends:"",readme:p};if(M.push(`import '${C}/${c}/${t}/${t}';`),await H($(y,t,"__examples__"))){let n=await _($(y,t,"__examples__"));for(let s of n)await x($(y,t,"__examples__",s,`${s}.ts`))?(M.push(`import '${C}/${c}/${t}/__examples__/${s}/${s}';`),l.examples.push({namespace:c,component:t,example:s,tag:`x-${c}-${T(t)}-${T(s)}`,className:`X${I(c)}${I(t)}${I(s)}`})):console.log(O(`Missing ${C}/${c}/${t}/__examples__/${s}/${s}.ts`))}let i=(await S($(A,C,c,t,`${t}.ts`),"utf8")).match(/class (\w+) extends (\w+)/);i||(console.log(O(`Component "${c}-${t}" must extend HtmlElement or base class`)),process.exit()),l.className=i[1],l.classExtends=i[2],P.components.push(l)}}return e.after(g),{contents:M.join(`
`),resolveDir:$(process.cwd(),A)}})}}}import{join as L}from"node:path";import{readFile as K}from"node:fs/promises";async function X({mode:e,rootDir:a,srcDir:m,indexFile:d,defaultDir:v,playgroundFile:M,title:E,repo:g,repoComponent:c,navigation:P,namespaces:y}){let o="";await x(L(a,m,d))?o=await K(L(a,m,d),"utf8"):o=await K(L(v,M),"utf8"),o=o.replace("<title>Default</title>",`<title>${E??"Default"}</title>`),o=o.replace("<h1>Default</h1>",`<h1>${E??"Default"}</h1>`);let t=structuredClone(P??[]);for(let i of t)i.items=[];let p;t.length===0?(p={label:"Components",items:[]},t.push(p)):(p=t.find(i=>!i.extends&&!i.components&&!i.namespaces),p||(p={label:"Other",items:[]},t.push(p)));let l=new Map;if(y.forEach(({components:i})=>{i.forEach(({component:n,namespace:s,tag:f,readme:D,examples:F,className:h,classExtends:N})=>{l.set(h,{className:h,classExtends:N,component:n,namespace:s,tag:f,readme:D,examples:F.map(r=>r.className)}),F.forEach(r=>{l.set(r.className,{className:r.className,classExtends:r.classExtends,component:r.component,namespace:r.namespace,tag:r.tag,example:r.example})});for(let r of t)if(r.include&&r.include.includes(h)){r.items.push({namespace:s,component:n,className:h,tag:f});return}for(let r of t)if(r!==p&&!(r.exclude&&r.exclude.includes(h))&&!(r.namespaces&&!r.namespaces.includes(s))&&!(r.extends&&!r.extends.includes(N))){r.items.push({namespace:s,component:n,className:h,tag:f});return}p.items.push({namespace:s,component:n,examples:F,className:h,tag:f})})}),o=o.replace(/([ ]*)<!-- \[Navigation\] -->/,(i,n)=>t.map(({label:s,items:f})=>[n,`<div>${s}</div>`,"<ul>",f.map(({component:D,namespace:F,tag:h,className:N})=>[`<li data-tag="${h}" data-class-name="${N}" data-component="${D}"><a href="#${h}">${D}</a></li>`].join(`
${n}`)).join(`
${n}`),"</ul>"].join(`
${n}`)).join(`
${n}`)),g){let s=g.includes("github.com")?"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z":"M6,2H18A2,2 0 0,1 20,4V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2M12.75,13.5C15.5,13.5 16.24,11.47 16.43,10.4C17.34,10.11 18,9.26 18,8.25C18,7 17,6 15.75,6C14.5,6 13.5,7 13.5,8.25C13.5,9.19 14.07,10 14.89,10.33C14.67,11 14,12 12,12C10.62,12 9.66,12.35 9,12.84V8.87C9.87,8.56 10.5,7.73 10.5,6.75C10.5,5.5 9.5,4.5 8.25,4.5C7,4.5 6,5.5 6,6.75C6,7.73 6.63,8.56 7.5,8.87V15.13C6.63,15.44 6,16.27 6,17.25C6,18.5 7,19.5 8.25,19.5C9.5,19.5 10.5,18.5 10.5,17.25C10.5,16.32 9.94,15.5 9.13,15.18C9.41,14.5 10.23,13.5 12.75,13.5M8.25,16.5A0.75,0.75 0 0,1 9,17.25A0.75,0.75 0 0,1 8.25,18A0.75,0.75 0 0,1 7.5,17.25A0.75,0.75 0 0,1 8.25,16.5M8.25,6A0.75,0.75 0 0,1 9,6.75A0.75,0.75 0 0,1 8.25,7.5A0.75,0.75 0 0,1 7.5,6.75A0.75,0.75 0 0,1 8.25,6M15.75,7.5A0.75,0.75 0 0,1 16.5,8.25A0.75,0.75 0 0,1 15.75,9A0.75,0.75 0 0,1 15,8.25A0.75,0.75 0 0,1 15.75,7.5Z";o=o.replace(/([ ]*)<!-- \[Repo\] -->/,(f,D)=>[D,`<a href="${g}">`,'  <svg viewBox="0 0 24 24">',`    <path fill="currentColor" d="${s}" />`,"  </svg>","  <span>View Repo</span>","</a>"].join(`
${D}`)),o=o.replace(/const repo = '';/,f=>`const repo = '${g}';`),o=o.replace(/const repoComponent = '';/,f=>`const repoComponent = '${c.replace(/\$repo/g,g)}';`),o=o.replace(/const repoIcon = '';/,f=>`const repoIcon = '${s}';`)}e==="dev"&&(o=o.replace(/([ ]*)<!-- \[info\] -->/,(i,n)=>[n,"<p>This page is generated from <code>npm start</code>. To render only specific components use <code>npm start c-button</code>.</p>"].join(`
${n}`)));let u=[...l.keys()];return o=o.replace(/([ ]*)const componentMap = new Map\(\);/,(i,n)=>[`${n}const componentMap = new Map();`,...u.map(s=>{let f=l.get(s);return`componentMap.set('${s}', ${JSON.stringify(f)});`})].join(`${n}
`)),o=o.replace(/([ ]*)const navigation = \[\];/,(i,n)=>`${n}const navigation = ${JSON.stringify(t,null,"  ")};`),o}var V=[Z],U=[],xe=e=>`\x1B[32m${e}\x1B[0m`,Ce=e=>`\x1B[31m${e}\x1B[0m`,G="node_modules",we="playground.html",be=de(import.meta.url),De=ye(be),Y=w(De,"..","default"),Q="index.html";var j="src",ee="components",te="element.config.ts",b=process.cwd(),R="build",_e=ge(te);await x(te)||(console.log(Ce("Missing element.config.ts in root."),"Add with content:"),console.log("export default {"),console.log("  namespace: 'hello',"),console.log("}"),process.exit());var Ae=await import(_e.href),{namespace:W,title:ve,repo:Me,repoComponent:Ee,navigation:Pe,external:je}=Ae.default,Fe=await _(w(b,j,ee)),ne=new Map;for(let e of je??[])(await _(w(b,G,...e.split("/")))).forEach(m=>{m!==G&&ne.set(m,e)});V.push(B({localNamespaces:Fe,externalNamespaces:ne}));W?(console.log(xe("Building app...")),U.push(`./${j}/${ee}/${W}/app/app.ts`)):(U.push("playground-entry"),V.push(J({after:async e=>{let a=await X({mode:"production",rootDir:b,srcDir:j,indexFile:Q,defaultDir:Y,playgroundFile:we,title:ve,repo:Me,repoComponent:Ee,navigation:Pe,namespaces:e});await $e(w(b,R,Q),a)}})));he({entryPoints:U,bundle:!0,platform:"browser",outfile:`./${R}/main.js`,sourcemap:!1,minify:!0,format:"esm",target:"es2024",loader:{".html":"text",".css":"text"},plugins:V}).then(async()=>{let e="favicon.svg";await x(w(b,j,e))?await q(w(b,j,e),w(b,R,e)):await q(w(Y,e),w(b,R,e))}).catch(e=>{process.stderr.write(e.stderr),process.exit(1)});

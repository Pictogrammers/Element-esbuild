#!/usr/bin/env node
import { createRequire } from 'node:module'; const require = createRequire(import.meta.url);
import{fileURLToPath as he,pathToFileURL as $e}from"node:url";import{build as ye}from"esbuild";import{join as se,sep as B}from"node:path";import{readFile as re}from"node:fs/promises";function V(e){return e.replace(/-([a-z])/g,a=>a[1].toUpperCase())}var ae=process.cwd(),ie=ae.split(B).length,ce=e=>`\x1B[31m${e}\x1B[0m`,z=process.env.INIT_CWD,le="";z?le=se(z,"node_modules"):(console.log("INIT_CWD not available. The script was likely not run via `npm run`."),process.exit());function Z({localNamespaces:e,externalNamespaces:a}){return{name:"html-dependents-plugin",setup(m){m.onLoad({filter:/\.html$/},async d=>{let A=d.path.split(B).splice(ie),[M,E,g,c,...P]=A,y=await re(d.path,"utf8"),o=y.matchAll(/<\/(?<namespace>\w+)-(?<value>[^>]+)/g),t=new Map;for(let l of o){let{namespace:u,value:i}=l.groups,n=V(i);t.set(`${u}-${n}`,[u,n])}let p=[];return t.forEach(([l,u])=>{let i=A.length-4,n=new Array(i).fill("..");if(l===g){if(u===c)return;p.push(`import './${n.join("/")}/${u}/${u}';`)}else if(e.includes(l))p.push(`import './${n.join("/")}/${l}/${u}/${u}';`);else if(a.has(l)){n.push(".."),n.push(".."),n.push("..");let s=a.get(l);p.push(`import '${s}/${l}/${u}';`)}else console.log(ce(`Unable to find namespace folder "${l}". Possibly missing 'external' in element.config.ts`)),process.exit()}),p.push(`export default \`${y}\`;`),{contents:p.join(`
`),loader:"js"}})}}}var pe=e=>`\x1B[32m${e}\x1B[0m`,H={name:"rebuild-notify",setup(e){e.onEnd(a=>{a.errors.length>0?console.error(`Build ended with ${a.errors.length} errors`):console.log(pe("Build succeeded!"))})}};import{access as me}from"node:fs/promises";import{constants as ue}from"node:fs";async function x(e){try{return await me(e,ue.F_OK),!0}catch{return!1}}import{copyFile as q,writeFile as xe}from"node:fs/promises";import{dirname as Ce,join as w}from"node:path";import{join as $}from"node:path";import{readdir as fe}from"node:fs/promises";async function D(e){let a=[];try{let m=await fe(e,{withFileTypes:!0});for(let d of m)d.isDirectory()&&a.push(d.name)}catch(m){console.error("Error reading directory:",m)}return a}import{access as de}from"node:fs/promises";import{constants as ge}from"node:fs";async function S(e){try{return await de(e,ge.F_OK),!0}catch{return!1}}import{readFile as J}from"node:fs/promises";function I(e){return e&&e.charAt(0).toUpperCase()+e.slice(1)}function T(e){return e.replace(/([a-zA-Z])(?=[A-Z])/g,"$1-").toLowerCase()}var O=e=>`\x1B[31m${e}\x1B[0m`,at=process.cwd();var v="src",C="components";function K(e){return{name:"playground-plugin",setup(a){let m="playground-entry",d="playground-module";a.onResolve({filter:new RegExp(`^${m}$`)},A=>({path:m,namespace:d})),a.onLoad({filter:/.*/,namespace:d},async A=>{let M=[],E=await D($(v,C));E.length===0&&(console.log(O('Missing at least 1 namespace folder under "src/components/"')),process.exit());let g=[];for(let c of E){let P={namespace:c,components:[]};g.push(P);let y=$(v,C,c),o=await D(y);for(let t of o)if(await x($(v,C,c,t,`${t}.ts`))){let p="";await x($(v,C,c,t,"README.md"))&&(p=await J($(v,C,c,t,"README.md"),"utf8"));let l={namespace:c,component:t,tag:`${c}-${T(t)}`,examples:[],className:"",classExtends:"",readme:p};if(M.push(`import '${C}/${c}/${t}/${t}';`),await S($(y,t,"__examples__"))){let n=await D($(y,t,"__examples__"));for(let s of n)await x($(y,t,"__examples__",s,`${s}.ts`))?(M.push(`import '${C}/${c}/${t}/__examples__/${s}/${s}';`),l.examples.push({namespace:c,component:t,example:s,tag:`x-${c}-${T(t)}-${T(s)}`,className:`X${I(c)}${I(t)}${I(s)}`})):console.log(O(`Missing ${C}/${c}/${t}/__examples__/${s}/${s}.ts`))}let i=(await J($(v,C,c,t,`${t}.ts`),"utf8")).match(/class (\w+) extends (\w+)/);i||(console.log(O(`Component "${c}-${t}" must extend HtmlElement or base class`)),process.exit()),l.className=i[1],l.classExtends=i[2],P.components.push(l)}}return e.after(g),{contents:M.join(`
`),resolveDir:$(process.cwd(),v)}})}}}import{join as k}from"node:path";import{readFile as W}from"node:fs/promises";async function X({mode:e,rootDir:a,srcDir:m,indexFile:d,defaultDir:A,playgroundFile:M,title:E,repo:g,repoComponent:c,navigation:P,namespaces:y}){let o="";await x(k(a,m,d))?o=await W(k(a,m,d),"utf8"):o=await W(k(A,M),"utf8"),o=o.replace("<title>Default</title>",`<title>${E??"Default"}</title>`),o=o.replace("<h1>Default</h1>",`<h1>${E??"Default"}</h1>`);let t=structuredClone(P??[]);for(let i of t)i.items=[];let p;t.length===0?(p={label:"Components",items:[]},t.push(p)):(p=t.find(i=>!i.extends&&!i.components&&!i.namespaces),p||(p={label:"Other",items:[]},t.push(p)));let l=new Map;if(y.forEach(({components:i})=>{i.forEach(({component:n,namespace:s,tag:f,readme:_,examples:N,className:h,classExtends:F})=>{l.set(h,{className:h,classExtends:F,component:n,namespace:s,tag:f,readme:_,examples:N.map(r=>r.className)}),N.forEach(r=>{l.set(r.className,{className:r.className,classExtends:r.classExtends,component:r.component,namespace:r.namespace,tag:r.tag,example:r.example})});for(let r of t)if(r.include&&r.include.includes(h)){r.items.push({namespace:s,component:n,className:h,tag:f});return}for(let r of t)if(r!==p&&!(r.exclude&&r.exclude.includes(h))&&!(r.namespaces&&!r.namespaces.includes(s))&&!(r.extends&&!r.extends.includes(F))){r.items.push({namespace:s,component:n,className:h,tag:f});return}p.items.push({namespace:s,component:n,examples:N,className:h,tag:f})})}),o=o.replace(/([ ]*)<!-- \[Navigation\] -->/,(i,n)=>t.map(({label:s,items:f})=>[n,`<div>${s}</div>`,"<ul>",f.map(({component:_,namespace:N,tag:h,className:F})=>[`<li data-tag="${h}" data-class-name="${F}" data-component="${_}"><a href="#${h}">${_}</a></li>`].join(`
${n}`)).join(`
${n}`),"</ul>"].join(`
${n}`)).join(`
${n}`)),g){let s=g.includes("github.com")?"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z":"M6,2H18A2,2 0 0,1 20,4V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2M12.75,13.5C15.5,13.5 16.24,11.47 16.43,10.4C17.34,10.11 18,9.26 18,8.25C18,7 17,6 15.75,6C14.5,6 13.5,7 13.5,8.25C13.5,9.19 14.07,10 14.89,10.33C14.67,11 14,12 12,12C10.62,12 9.66,12.35 9,12.84V8.87C9.87,8.56 10.5,7.73 10.5,6.75C10.5,5.5 9.5,4.5 8.25,4.5C7,4.5 6,5.5 6,6.75C6,7.73 6.63,8.56 7.5,8.87V15.13C6.63,15.44 6,16.27 6,17.25C6,18.5 7,19.5 8.25,19.5C9.5,19.5 10.5,18.5 10.5,17.25C10.5,16.32 9.94,15.5 9.13,15.18C9.41,14.5 10.23,13.5 12.75,13.5M8.25,16.5A0.75,0.75 0 0,1 9,17.25A0.75,0.75 0 0,1 8.25,18A0.75,0.75 0 0,1 7.5,17.25A0.75,0.75 0 0,1 8.25,16.5M8.25,6A0.75,0.75 0 0,1 9,6.75A0.75,0.75 0 0,1 8.25,7.5A0.75,0.75 0 0,1 7.5,6.75A0.75,0.75 0 0,1 8.25,6M15.75,7.5A0.75,0.75 0 0,1 16.5,8.25A0.75,0.75 0 0,1 15.75,9A0.75,0.75 0 0,1 15,8.25A0.75,0.75 0 0,1 15.75,7.5Z";o=o.replace(/([ ]*)<!-- \[Repo\] -->/,(f,_)=>[_,`<a href="${g}">`,'  <svg viewBox="0 0 24 24">',`    <path fill="currentColor" d="${s}" />`,"  </svg>","  <span>View Repo</span>","</a>"].join(`
${_}`)),o=o.replace(/const repo = '';/,f=>`const repo = '${g}';`),o=o.replace(/const repoComponent = '';/,f=>`const repoComponent = '${c.replace(/\$repo/g,g)}';`),o=o.replace(/const repoIcon = '';/,f=>`const repoIcon = '${s}';`)}e==="dev"&&(o=o.replace(/([ ]*)<!-- \[info\] -->/,(i,n)=>[n,"<p>This page is generated from <code>npm start</code>. To render only specific components use <code>npm start c-button</code>.</p>"].join(`
${n}`)));let u=[...l.keys()];return o=o.replace(/([ ]*)const componentMap = new Map\(\);/,(i,n)=>[`${n}const componentMap = new Map();`,...u.map(s=>{let f=l.get(s);return`componentMap.set('${s}', ${JSON.stringify(f)});`})].join(`${n}
`)),o=o.replace(/([ ]*)const navigation = \[\];/,(i,n)=>`${n}const navigation = ${JSON.stringify(t,null,"  ")};`),o}var U=[H],L=[],we=e=>`\x1B[32m${e}\x1B[0m`,be=e=>`\x1B[31m${e}\x1B[0m`,G="node_modules",_e="playground.html",De=he(import.meta.url),ve=Ce(De),ee=w(ve,"..","default"),Q="index.html";var j="src",te="components",ne="element.config.ts",b=process.cwd(),R="build",Ae=$e(ne);await x(ne)||(console.log(be("Missing element.config.ts in root."),"Add with content:"),console.log("export default {"),console.log("  namespace: 'hello',"),console.log("}"),process.exit());var Me=await import(Ae.href),{namespace:Y,title:Ee,repo:Pe,repoComponent:je,navigation:Ne,external:Fe}=Me.default,Ie=await D(w(b,j,te)),oe=new Map;for(let e of Fe??[])(await D(w(b,G,...e.split("/")))).forEach(m=>{m!==G&&oe.set(m,e)});U.push(Z({localNamespaces:Ie,externalNamespaces:oe}));Y?(console.log(we("Building app...")),L.push(`./${j}/${te}/${Y}/app/app.ts`)):(L.push("playground-entry"),U.push(K({after:async e=>{let a=await X({mode:"production",rootDir:b,srcDir:j,indexFile:Q,defaultDir:ee,playgroundFile:_e,title:Ee,repo:Pe,repoComponent:je,navigation:Ne,namespaces:e});await xe(w(b,R,Q),a)}})));ye({entryPoints:L,bundle:!0,platform:"browser",outfile:`./${R}/main.js`,sourcemap:!1,minify:!0,format:"esm",target:"es2024",loader:{".html":"text",".css":"text"},plugins:U}).then(async()=>{let e="favicon.svg";await x(w(b,j,e))?await q(w(b,j,e),w(b,R,e)):await q(w(ee,e),w(b,R,e))}).catch(e=>{process.stderr.write(e.stderr),process.exit(1)});
